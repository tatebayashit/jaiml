# âœ… CIä»•æ§˜ v1.0ï¼šJAIMLçµ±åˆCIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ

## ğŸ”§ ç›®çš„

| ã‚«ãƒ†ã‚´ãƒª          | ç›®çš„å†…å®¹                                                    |
| ------------- | ------------------------------------------------------- |
| **å†ç¾æ€§ã®ä¿è¨¼**    | ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ»ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ç­‰ãŒã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ä¸€è‡´ã—ã¦ã„ã‚‹ã“ã¨ã‚’æ¤œè¨¼                 |
| **å®‰å…¨æ€§ã®æ‹…ä¿**    | Pickleä¾å­˜ã®å±é™ºæ€§ã‚„scikit-learnã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ãªã©ã‚’äº‹å‰ã«æ¤œå‡º              |
| **æ§‹æˆãƒŸã‚¹é˜²æ­¢**    | YAMLæ§‹æ–‡ã®ä¸å‚™ãƒ»æœªå®šç¾©ãƒ‘ã‚¹ãƒ»ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã€è¨­è¨ˆã¨å®Ÿè£…ã®å·®åˆ†ã‚’æ¤œçŸ¥                    |
| **CI/CDçµ±åˆæº–å‚™** | github actionsç­‰ã®CIç’°å¢ƒã§è‡ªå‹•çš„ã«ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¨æ§‹æˆæ¤œè¨¼ã‚’è¡Œã„ã€ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’æ—©æœŸæ¤œå‡ºå¯èƒ½ã« |

---

## ğŸ§ª ãƒã‚§ãƒƒã‚¯é …ç›®ã¨å®Ÿè£…æ¡ˆ

### 1. tfidf_config.yaml æ¤œè¨¼ï¼ˆå†ç¾æ€§ï¼‰

| é …ç›®             | æ¤œè¨¼å†…å®¹                                                        |
| -------------- | ----------------------------------------------------------- |
| YAMLã‚¹ã‚­ãƒ¼ãƒæ§‹æ–‡æ¤œè¨¼   | `ci/schema_validate.py` ã«ã‚ˆã‚Š `tfidf_config_schema.yaml` ã¨ç…§åˆ  |
| ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã¨ã®æ•´åˆæ€§ç¢ºèª | `config/global.yaml` ã«è¨˜è¼‰ã•ã‚ŒãŸ `min_df`, `ngram_range` ç­‰ã¨ä¸€è‡´ã‚’ç¢ºèª |
| ç¦æ­¢å€¤ãƒã‚§ãƒƒã‚¯        | `min_df=0` ã‚„ `ngram_range=(0,0)` ã®ã‚ˆã†ãªç„¡åŠ¹å€¤ã‚’æ¤œçŸ¥                 |

**ä½¿ç”¨æŠ€è¡“æ¡ˆ**ï¼š

```bash
pip install jsonschema
python ci/schema_validate.py
```

---

### 2. Pickleä½¿ç”¨ã®é™çš„è­¦å‘Šï¼ˆå®‰å…¨æ€§ï¼‰

| é …ç›®              | æ¤œè¨¼å†…å®¹                                                             |
| --------------- | ---------------------------------------------------------------- |
| Pickleã®importæ¤œå‡º | `pickle.load` ä½¿ç”¨ç®‡æ‰€ã‚’ grepã—ã€è­¦å‘Šã‚³ãƒ¡ãƒ³ãƒˆãŒä»˜ã„ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯                     |
| æ¨å¥¨æ–¹å¼ã¨ã®å·®åˆ†        | `joblib.dump(..., compress=3)` ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª                     |
| metadataå­˜åœ¨ç¢ºèª    | `vectorizers/metadata.json` ãŒ `tfidf_vectorizer.joblib` ã«ä»˜å±ã—ã¦ã„ã‚‹ã‹ |

**ä½¿ç”¨æŠ€è¡“æ¡ˆ**ï¼š

```bash
grep -nr "pickle.load" src/
# å„ç®‡æ‰€ã«ã€Œä¿¡é ¼æ¸ˆã¿ç’°å¢ƒã§ã®ã¿ä½¿ç”¨ã€ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã‹ç¢ºèª
```

---

### 3. sklearn ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

| é …ç›®          | æ¤œè¨¼å†…å®¹                                                   |
| ----------- | ------------------------------------------------------ |
| ä¿å­˜æ™‚ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ² | `metadata.json` ã« `sklearn_version` ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹          |
| å®Ÿè¡Œæ™‚ã®ä¸€è‡´ç¢ºèª    | `corpus_based.py` ã«ã¦ `joblib` ãƒ­ãƒ¼ãƒ‰å¾Œã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹æ¤œè¨¼ã™ã‚‹å‡¦ç† |

```json
// metadata.json ã®ä¾‹
{
  "model_version": "v1.0",
  "sklearn_version": "1.7.0"
}
```

---

### 4. JSONLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¤œæŸ»ï¼ˆå…¥åŠ›å½¢å¼ï¼‰

| é …ç›®        | æ¤œè¨¼å†…å®¹                                                                             |
| --------- | -------------------------------------------------------------------------------- |
| JSONãƒ‘ãƒ¼ã‚¹æ¤œè¨¼ | `vector_pretrainer/corpus/jsonl/*.jsonl` ãŒå„è¡Œã§ `user`, `response`, `metadata` ã‚’æŒã¤ |
| æ”¹è¡Œã®å­˜åœ¨     | æœ€çµ‚è¡Œã«æ”¹è¡ŒãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆjsonlinesä»•æ§˜ä¸Šã®äº’æ›æ€§ç¢ºä¿ï¼‰                                               |

**ä½¿ç”¨æŠ€è¡“æ¡ˆ**ï¼ˆæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼‰ï¼š

```python
with open("sample.jsonl") as f:
    for i, line in enumerate(f):
        obj = json.loads(line)
        assert 'user' in obj and 'response' in obj
```

---

### 5. çµ±åˆãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆCI/CDç”¨ï¼‰

| ãƒ†ã‚¹ãƒˆå†…å®¹                             | å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«                                             |
| --------------------------------- | -------------------------------------------------- |
| TF-IDFã‚¹ã‚³ã‚¢ãŒæ­£å¸¸ã«å‡ºåŠ›ã•ã‚Œã‚‹ã‹               | `tests/test_features.py`                           |
| load_model ãŒ vectorizer ã‚’æ­£å¸¸ã«èª­è¾¼ã‚€ã‹ | `test_features.py::test_load_model_consistency`    |
| tokenizer ãŒ fugashi ã§çµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ã‹     | `test_tokenize.py` ã§ `assert tokenizer=="fugashi"` |

---

## ğŸ§© CIå°å…¥ä¾‹ï¼ˆGitHub Actionsï¼‰

```yaml
# .github/workflows/ci.yaml
name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run YAML schema validation
        run: python src/ci/schema_validate.py
      - name: Run unit tests
        run: pytest src/model/jaiml_v3_3/tests
```

---

## ğŸ“Œ ä»Šå¾Œã®æ‹¡å¼µæ¡ˆ

| é …ç›®                | æ¦‚è¦                                                        |
| ----------------- | --------------------------------------------------------- |
| YAML config å·®åˆ† CI | `tfidf_config.yaml` ã®æ”¹è¨‚ãŒ `global.yaml` ã‚’å¤‰æ›´ã›ãšã«è¡Œã‚ã‚ŒãŸå ´åˆã«CIã§æ¤œçŸ¥ |
| Pickle ç¦æ­¢ Linter  | flake8 + plugin ã§ `pickle.load` ä½¿ç”¨ç®‡æ‰€ã‚’ lint æ™‚ã«è­¦å‘Š           |
| ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ¤œæŸ»        | ã‚³ãƒ¼ãƒ‘ã‚¹ä½¿ç”¨æ™‚ã« LICENSE ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ã¨éµå®ˆé …ç›®ã‚’ãƒã‚§ãƒƒã‚¯                         |

---

## âœ… çµè«–

ã“ã® CI è¨­è¨ˆã«ã‚ˆã‚Šã€**ãƒ™ã‚¯ãƒˆãƒ«äº‹å‰å­¦ç¿’ãƒ»ç‰¹å¾´æŠ½å‡ºãƒ»æ¨è«–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå…¨ã¦æ§‹æˆçš„ã«åŒæœŸã•ã‚Œã€å®‰å…¨ãƒ»å†ç¾å¯èƒ½ãªåˆ†æç’°å¢ƒãŒä¿è¨¼**ã•ã‚Œã‚‹ã€‚é–‹ç™ºè€…ã¯ CI ã§å¤±æ•—ã‚’æ—©æœŸç™ºè¦‹ã—ã€è¨­è¨ˆãƒ‰ãƒªãƒ•ãƒˆã‚’æŠ‘æ­¢ã§ãã‚‹ã€‚